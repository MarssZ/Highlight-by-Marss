# 需求文档：对话导出功能 (Conversation Export)

## 介绍

### 背景
用户在使用AI聊天平台（Gemini、Claude、ChatGPT、Grok等）时，经常需要记录完整对话用于回顾学习、分享或存档。当前痛点：
- 浏览器直接复制整个页面：格式混乱，无法使用
- 逐条点击现有复制按钮：每次耗时10分钟，效率极低
- 粘贴后的内容：无法区分用户和AI，看不清对话轮次

### 目标
提供一键复制整个对话的功能，自动格式化为结构化Markdown，清晰标记发言者和对话轮次。

### MVP范围
- ✅ 复制当前页面所有可见对话
- ✅ 自动格式化为带轮次的Markdown
- ✅ 通过扩展图标触发
- ❌ 不支持选区复制（保留到二期）
- ❌ 不处理懒加载历史消息（MVP阶段提示用户手动滚动）

---

## 需求

### 需求1：一键复制全部对话
**用户故事：** 作为AI聊天平台的用户，我希望通过点击扩展图标一键复制整个对话，以便快速保存完整的对话记录到Markdown文件中。

#### 验收标准
1. WHEN 用户点击浏览器工具栏的扩展图标 THEN 系统 SHALL 复制当前页面的全部对话内容到剪贴板
2. WHEN 复制成功 THEN 系统 SHALL 显示成功提示（如："已复制 X 轮对话"）
3. WHEN 复制失败（如页面无对话） THEN 系统 SHALL 显示错误提示（如："未检测到对话内容"）
4. WHEN 用户在非AI聊天平台页面点击图标 THEN 系统 SHALL 显示提示（如："当前页面不支持此功能"）

---

### 需求2：Markdown格式化
**用户故事：** 作为用户，我希望复制的对话自动格式化为结构化Markdown，以便粘贴后能清晰看出对话轮次和发言者。

#### 验收标准
1. 复制的内容 SHALL 包含以下元素：
   - 标题：`## 对话记录 [日期] [时间]`（如：`## 对话记录 2025-01-15 14:30`）
   - 平台标识：`**平台：** [平台名称]`（如：`**平台：** Gemini`）
   - 轮次分隔：每轮对话以 `### 第X轮` 标记

2. WHEN 格式化单条消息 THEN 系统 SHALL 使用以下格式：
   ```markdown
   **用户：**
   [用户消息内容]

   **[平台名称]：**
   [AI回复内容]
   ```

3. IF 消息中包含代码块 THEN 系统 SHALL 保留原始Markdown代码块格式（三个反引号）

4. IF 消息中包含特殊Markdown字符（如`*`、`#`等） THEN 系统 SHALL 正确转义或保留

5. 完整输出示例 SHALL 符合以下格式：
   ```markdown
   # 对话记录 2025-01-15 14:30

   **平台：** Gemini

   # 第1轮
   **用户：**
   帮我写一个Python函数计算斐波那契数列

   **Gemini：**
   好的，这是一个计算斐波那契数列的Python函数：

   ```python
   def fibonacci(n):
       if n <= 1:
           return n
       return fibonacci(n-1) + fibonacci(n-2)
   ```

   # 第2轮
   **用户：**
   能否优化一下性能？

   **Gemini：**
   当然，可以使用动态规划...
   ```

---

### 需求3：平台识别与适配
**用户故事：** 作为用户，我希望在不同AI平台都能使用此功能，且复制内容能标记具体平台名称，以便区分对话来源。

#### 验收标准
1. 系统 SHALL 支持以下平台：
   - Gemini (gemini.google.com)
   - Claude (claude.ai)
   - ChatGPT (chatgpt.com 或 chat.openai.com)
   - Grok (x.com)

2. WHEN 在支持的平台复制对话 THEN 系统 SHALL 在Markdown中显示正确的平台名称：
   - Gemini → `**平台：** Gemini`
   - Claude → `**平台：** Claude`
   - ChatGPT → `**平台：** ChatGPT`
   - Grok → `**平台：** Grok`

3. IF 用户在未支持的平台点击图标 THEN 系统 SHALL 显示提示："当前平台暂不支持对话导出"

---

### 需求4：懒加载处理（MVP版本）
**用户故事：** 作为用户，当页面存在未加载的历史消息时，我希望系统能提示我需要手动加载，以便确保复制完整对话。

#### 验收标准
1. WHEN 检测到页面可能存在懒加载历史消息 THEN 系统 SHALL 在复制前显示提示：
   - "检测到可能有未加载的历史消息，请滚动到页面顶部加载全部对话后再试"

2. IF 无法准确检测懒加载状态 THEN 系统 SHALL 在复制成功后的提示中加入提醒：
   - "已复制 X 轮对话（如有历史消息未加载，请先滚动到顶部）"

3. MVP阶段 SHALL NOT 实现自动滚动加载历史消息功能

---

### 需求5：数据提取准确性
**用户故事：** 作为用户，我希望复制的内容与页面显示完全一致，以便准确记录对话。

#### 验收标准
1. 系统 SHALL 按照时间顺序提取对话（从最早到最新）

2. WHEN 提取AI回复内容 THEN 系统 SHALL 使用平台适配器已有的清理逻辑：
   - 移除平台特有的引用标记（如Gemini的`[1]`、`[2]`）
   - 保留代码块、列表、引用等Markdown格式
   - 移除不可见的UI元素（按钮、图标等）

3. WHEN 提取用户消息 THEN 系统 SHALL 获取用户输入的原始内容

4. IF 某条消息提取失败 THEN 系统 SHALL 跳过该消息并继续处理，不中断整体流程

---

## 技术约束

1. **零DOM污染**：不修改页面DOM，只读取内容
2. **复用现有架构**：使用现有的平台适配器模式
3. **向后兼容**：不影响现有高亮、评论、单条复制功能
4. **跨平台兼容**：Windows、macOS、Linux的剪贴板API一致性

---

## 非功能需求

1. **性能**：
   - 复制100轮对话应在2秒内完成
   - 不阻塞页面交互

2. **用户体验**：
   - 操作反馈即时（<300ms显示提示）
   - 错误提示清晰明确
   - 成功提示包含统计信息（复制了多少轮）

3. **可维护性**：
   - 新增平台只需实现对应适配器方法
   - Markdown格式化逻辑独立可测试

---

## 未来扩展（非MVP范围）

- 支持选区复制（按住CTRL+点击复制按钮复制到当前位置）
- 自动检测并加载懒加载历史消息
- 导出为文件（JSON、Markdown、PDF）
- 自定义Markdown格式模板
- 对话历史管理（浏览器本地存储）
