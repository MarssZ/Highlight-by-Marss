# AI Highlight Assistant - 渐进式实现任务清单

## 阶段1：基础架构 - 立即可见

- [x] 1. 创建最小Chrome扩展
  - 需求：REQ-3.1 自动激活高亮功能
  - 文件：`manifest.json`, `src/content.js`
  - 验证：**已完成** - 在Chrome扩展管理页面看到扩展加载成功，在Gemini页面控制台看到"AI Highlight Assistant loaded"消息

- [x] 2. 实现基础文本高亮功能
  - 需求：REQ-1.2 高亮显示选中文本
  - 文件：`src/content.js`（扩展）
  - 验证：**已完成** - 在Gemini页面选中任意文本，文本立即变成黄色背景
  
  - [x] 2.1 监听文本选择事件
    - document.addEventListener('mouseup')
  - [x] 2.2 应用高亮样式
    - 用span包装，添加background-color: yellow

## 阶段2：高亮控制优化 - 已完成

- [x] 3. **已跳过** - 右键菜单功能（用户反馈：多此一举）
  - 理由：选中即高亮更直观，右键菜单增加操作复杂度

- [x] 4. 实现CSS.highlights API高亮功能  
  - 需求：REQ-1.2 支持跨元素文本高亮
  - 文件：`src/content.js`（重构）
  - 验证：**已完成** - 支持跨越多个元素的复杂文本选择，无DOM污染

- [x] 5. 实现Ctrl+点击取消高亮功能
  - 需求：REQ-1.3 精确移除高亮
  - 文件：`src/content.js`（扩展）
  - 验证：**已完成** - Ctrl+单击黄色高亮文本移除，避免误触

## 阶段3：增强现有复制功能 - 无需新UI

- [x] 6. 识别并监听Gemini现有的复制按钮
  - 需求：REQ-2.1 劫持现有复制功能
  - 文件：`src/copy-enhancer.js`
  - 验证：**已完成** - 精确识别AI回复复制按钮，成功监听点击事件

- [x] 7. 实现智能复制逻辑
  - 需求：REQ-2.2, REQ-2.4 检测高亮并生成带标签内容
  - 文件：`src/copy-enhancer.js`（扩展）
  - 验证：**已完成** - 点击有高亮的AI回复复制按钮，粘贴时看到带`<highlight>`标签的内容

## 阶段4：剪贴板功能 - 立即可测

- [ ] 8. 实现文本内容提取和标签生成
  - 需求：REQ-2.3, REQ-2.4 保持原文结构，生成高亮标签
  - 文件：`src/text-processor.js`
  - 验证：**人工验证** - 控制台输出生成的文本，格式为"原文包含<highlight>高亮部分</highlight>的内容"

- [ ] 9. 实现剪贴板复制功能
  - 需求：REQ-2.2 复制到剪贴板
  - 文件：`src/clipboard.js`
  - 验证：**人工验证** - 点击复制按钮→在任意文本编辑器粘贴→看到带`<highlight>`标签的完整AI回复内容

- [ ] 10. 添加复制成功提示
  - 需求：用户体验优化
  - 文件：`src/notification.js`
  - 验证：**人工验证** - 点击复制按钮后看到"已复制到剪贴板"的临时提示消息

## 阶段5：数据持久化 - 刷新测试

- [ ] 11. 实现存储数据结构
  - 需求：REQ-1.4 页面刷新保持高亮
  - 文件：`src/storage.js`
  - 验证：**人工验证** - 高亮文本后，Chrome扩展存储中看到保存的高亮数据

- [ ] 12. 实现页面加载时恢复高亮
  - 需求：REQ-1.4 保持高亮状态
  - 文件：`src/restore.js`
  - 验证：**人工验证** - 高亮文本→刷新页面→高亮效果依然存在，复制按钮正确显示

- [ ] 13. 优化存储键生成逻辑
  - 需求：数据可靠性
  - 文件：`src/storage.js`（优化）
  - 验证：**人工验证** - 在不同Gemini对话中高亮，数据不会互相干扰

## 阶段6：完善和容错 - 边界测试

- [ ] 14. 处理跨元素文本选择
  - 需求：REQ-1.2 复杂文本高亮
  - 文件：`src/content.js`（增强）
  - 验证：**人工验证** - 选择跨越多个段落的文本，高亮效果正确应用

- [ ] 15. 实现错误处理和降级
  - 需求：稳定性保证
  - 文件：`src/error-handler.js`
  - 验证：**人工验证** - 在网络断开或存储失败时，功能降级但不崩溃

- [ ] 16. 添加动态内容监听
  - 需求：REQ-3.2 处理动态加载的AI回复
  - 文件：`src/content.js`（MutationObserver）
  - 验证：**人工验证** - 在长对话中新生成的AI回复也能正常高亮和复制

## 每步验证方法

### 阶段1验证
- ✅ 打开Chrome扩展管理页面 → 看到扩展已加载
- ✅ 访问gemini.google.com → F12控制台看到初始化消息
- ✅ 选中页面任意文本 → 立即变黄色

### 阶段2验证  
- ✅ 选中简单文本 → 立即变黄色高亮
- ✅ 选中跨元素复杂文本 → 正常高亮（解决surroundContents错误）
- ✅ Ctrl+单击高亮文本 → 高亮消失
- ✅ Ctrl+Z快捷键 → 撤销最后一个高亮
- ✅ 普通点击高亮文本 → 不受影响（避免误触）

### 阶段3验证 ✅ 已完成
- ✅ 识别AI回复现有复制按钮 → 控制台显示找到的按钮数量
- ✅ 高亮AI回复文本 → 不改变页面UI
- ✅ 点击AI回复的复制按钮 → 控制台显示"Copy button clicked"
- ✅ 点击AI回复的复制按钮（有高亮）→ 粘贴板中有带`<highlight>`标签的内容
- ✅ 点击AI回复的复制按钮（无高亮）→ 粘贴板中是普通文本

### 阶段5验证
- 高亮文本 → 刷新页面 → 高亮保持
- Chrome扩展存储中能看到数据

### 阶段6验证
- 选择复杂文本 → 高亮正常
- 各种边界情况测试

## 项目文件结构

```
ai-highlight-assistant/
├── manifest.json           # Chrome扩展配置
├── src/
│   ├── content.js         # 主要逻辑（阶段1-2）
│   ├── background.js      # 后台脚本（预留）
│   ├── copy-enhancer.js   # 复制功能增强（阶段3）
│   ├── text-processor.js  # 文本处理（阶段4）
│   ├── clipboard.js       # 剪贴板（阶段4）
│   ├── notification.js    # 通知提示（阶段4）
│   ├── storage.js         # 存储管理（阶段5）
│   ├── restore.js         # 恢复逻辑（阶段5）
│   └── error-handler.js   # 错误处理（阶段6）
└── styles/
    └── content.css        # 样式文件
```